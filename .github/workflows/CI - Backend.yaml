# Workflow name shown in GitHub Actions
name : CI - Backend ASP.NET Core

# Trigger the workflow on push or pull request to develop or feature branches
on:
  push:
    branches: [ "feature/*", "develop" ]
  pull_request:
    branches: [ "feature/*", "develop" ]
  
jobs:
  ci-backend:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    permissions: # Define the scopes of the GITHUB_TOKEN for this job
      contents: read # Allow reading repository code for analysis
      security-events: write # Required to upload security scanning results (CodeQL)
      packages: write # Grants permission to publish packages (e.g., GitHub Packages, containers)

    steps:
      # Download repo code to the runner
      - name: Checkout code
        uses: actions/checkout@v4

      # Setup and install .NET environment
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      # Cache NuGet packages
      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      # Restores project dependencies
      - name: Restore dependencies
        run: dotnet restore ./BackendShiftURL/BackendShiftURL/BackendShiftURL.csproj

      # Lint - Code formatting check
      - name: Lint (dotnet format)
        run: dotnet format ./BackendShiftURL/BackendShiftURL/BackendShiftURL.csproj  --verify-no-changes

      # Initialize CodeQL 
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: csharp

      # Builds the project in release mode
      - name: Build
        run: dotnet build ./BackendShiftURL/BackendShiftURL/BackendShiftURL.csproj --no-restore --configuration Release

      # CodeQL Analysis
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

      # Publish: Compiles and packages the application into ./publish folder
      - name: Publish app
        run: dotnet publish ./BackendShiftURL/BackendShiftURL/BackendShiftURL.csproj  -c Release -o ./publish --no-restore

      # Set up Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Login
      - name: Login to Docker GitHub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Build and push Docker image
      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./BackendShiftURL/BackendShiftURL/DockerfileBackend
          push: true
          tags: |
            itsleonardo/backend:latest
            itsleonardo/backend:staging  
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # Test Docker image locally
      - name: Test Docker image
        run: |
          # Run the container in detached mode
          docker run -d --name test-app -p 5000:5000 \
            -e ASPNETCORE_ENVIRONMENT=Staging \
            itsleonardo/backend:latest
          
          # Wait for container to start
          sleep 15
          
          # Test if container is running and responsive
          for i in {1..10}; do
            if curl -f -s http://localhost:5000/health > /dev/null 2>&1; then
              echo "Docker container health check passed"
              break
            elif curl -f -s http://localhost:5000 > /dev/null 2>&1; then
              echo "Docker container basic connectivity passed"
              break
            fi
            
            if [ $i -eq 10 ]; then
              echo "Docker container test failed"
              docker logs test-app
              exit 1
            fi
            
            echo "Attempt $i failed, retrying..."
            sleep 2
          done
          
          # Cleanup
          docker stop test-app
          docker rm test-app

      # Uploads the published app to GitHub Actions server as an artifact
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-artifact
          path: ./publish

      # Output image information
      - name: Image info
        run: |
          echo "Docker image built and pushed:"
          echo "- itsleonardo/backend:latest"